---
title: Ogres, Onions, Leaflet Maps...
author: Grace Acton
date: '2022-05-20'
slug: leaflet-layers
categories:
  - programming
tags:
  - maps
  - R
publishdate: '2022-05-20T15:00:00-04:00'
comments: yes
draft: true
---

## _They have layers._

This month I've been playing around with adding layers and layer controls to Leaflet maps. 

In my Short Term course, Community-Engaged Data Science, my group and I are helping researchers at the Maine Medical Center [Vector-borne Disease Lab](https://mmcri.org/?page_id=1090) by making maps of Lyme, Anaplasmosis, and Babesiosis cases in Maine. Because these are all tickborne illnesses, we wanted to be able to overlay all of the case rates and possible predictors of higher tick rates on a single map. 

#### It got pretty crowded, pretty fast.

```{r load_sources, echo=FALSE, warning=FALSE, message=FALSE}
# Loading Packages --------------------------------------------------------

library(tidyverse) ## dplyr, etc.
library(dplyr)
library(lubridate) ## helps with dates, might not be necessary
library(skimr) ## skim
library(magrittr) ## pipes
library(leaflet) ## For leaflet interactive maps
library(sf) ## For spatial data
library(RColorBrewer) ## For colour palettes
library(htmltools) ## For html
library(leafsync) ## For placing plots side by side
library(kableExtra) ## Table output
library(ggmap) ## for google geocoding and fortifying 
library(maptools) ## for reading KML files
library(rgdal)
library(rmapshaper)

# Loading Preliminary Data ------------------------------------------------------------

incidence <- read_csv("data/ticks/maine_tracking_network_incidence.csv")
rates <- read_csv("data/ticks/maine_tracking_network_rate.csv")
#prevalence <- read_csv("data/ticks/umaine_tickborne_prevalence_town.csv")

# Loading Spatial Data - leaflet ------------------------------------------

county_latlon_sf <- read_sf("data/spatial_data/counties/Maine_County_Boundary_Polygons_Feature.shp")
county_latlon_sf <- county_latlon_sf %>% 
  rmapshaper::ms_simplify(explode = TRUE, weighting = 0.3)
  

# town_latlon <- readOGR("data/spatial_data/towns/towns.shp")
# town_latlon <-spTransform(town_latlon, CRS("+proj=longlat +datum=WGS84 +no_defs")) 
# town_latlon_sf <- town_latlon %>% 
#   st_as_sf() %>% 
#   rmapshaper::ms_simplify(explode = TRUE, weighting = 0.5)

town_latlon_sf <- read_sf("data/spatial_data/towns/towns.shp")
town_latlon_sf <- town_latlon_sf %>% 
  rmapshaper::ms_simplify(explode = TRUE, weighting = 0.5)

conserved_lands_sf <- read_sf("data/spatial_data/Maine_Conserved_Lands.kml")


# Loading Provider Data ---------------------------------------------------

# fed_healthcenters <- read_csv("data/primary_care/federally_recognized_health_centers.csv")


# Cleaning Incidence Data -------------------------------------------------
  ## From Matt's data cleaning script 

case_numbers <- incidence %>% 
  mutate(Lyme_Label = Lyme) %>%
  mutate(Lyme_Label = str_replace(Lyme_Label, "NR", "Not Releasable")) %>%
  mutate(Lyme = str_replace(Lyme, "<6", "6")) %>%
  mutate(Lyme = str_replace(Lyme, "6-10", "8")) %>%
  mutate(Lyme = str_replace(Lyme, "11-15", "13")) %>%
  mutate(Babesiosis_Label = Babesiosis) %>%
  mutate(Babesiosis_Label = str_replace(Babesiosis_Label, "NR", "Not Releasable")) %>%
  mutate(Babesiosis = str_replace(Babesiosis, "<6", "6")) %>%
  mutate(Babesiosis = str_replace(Babesiosis, "6-10", "8")) %>%
  mutate(Babesiosis = str_replace(Babesiosis, "11-15", "13")) %>%
  mutate(Anaplasmosis_Label = Anaplasmosis) %>%
  mutate(Anaplasmosis_Label = str_replace(Anaplasmosis_Label, "NR", "Not Releasable")) %>%
  mutate(Anaplasmosis = str_replace(Anaplasmosis, "<6", "6")) %>%
  mutate(Anaplasmosis = str_replace(Anaplasmosis, "6-10", "8")) %>%
  mutate(Anaplasmosis = str_replace(Anaplasmosis, "11-15", "13")) %>% 
  mutate(lyme = as.numeric(Lyme),
         babesiosis = as.numeric(Babesiosis),
         anaplasmosis = as.numeric(Anaplasmosis)) %>% 
  select(Location, lyme, babesiosis, anaplasmosis, Population) %>% 
  arrange(desc(lyme))

# reformatting location variable in case_numbers
  ## From Matt's script
case_numbers <- case_numbers %>%
  mutate(Location = str_replace(Location, "Plt", "Plantation")) %>%
  mutate(Location = str_replace(Location, "Bancroft Twp", "Bancroft")) %>%
  mutate(Location = str_replace(Location, "Aroostook", "Aroostook Twp")) %>%
  mutate(Location = str_replace(Location, "Somerset", "Somerset Twp")) %>%
  mutate(Location = str_replace(Location, "East Hancock", "East Hancock Twp")) %>%
  mutate(Location = str_replace(Location, "Dennistown", "Dennis")) %>%
  mutate(Location = str_replace(Location, "East Central Washington", "East Central Washington Twp")) %>%
  mutate(Location = str_replace(Location, "East Central Franklin", "East Central Franklin Twp")) %>%
  mutate(Location = str_replace(Location, "West Central Franklin", "West Central Franklin Twp")) %>%
  mutate(Location = str_replace(Location, "North Franklin", "North Franklin Twp")) %>%
  mutate(Location = str_replace(Location, "South Franklin", "South Franklin Twp")) %>%
  mutate(Location = str_replace(Location, "West Franklin", "West Franklin Twp")) %>%
  mutate(Location = str_replace(Location, "East Central Penobscot", "East Central Penobscot Twp")) %>%
  mutate(Location = str_replace(Location, "Louds Island", "Louds Island Twp")) %>%
  mutate(Location = str_replace(Location, "Marshall Island", "Marshall Island Twp")) %>%
  mutate(Location = str_replace(Location, "Monhegan Island Plantation", "Monhegan Plantation")) %>%
  mutate(Location = str_replace(Location, "Islands", "Islands Twp")) %>%
  mutate(Location = str_replace(Location, "North Oxford", "North Oxford Twp")) %>%
  mutate(Location = str_replace(Location, "South Oxford", "South Oxford Twp")) %>%
  mutate(Location = str_replace(Location, "North Washington", "North Washington Twp")) %>%
  mutate(Location = str_replace(Location, "North Penobscot", "North Penobscot Twp")) %>%
  mutate(Location = str_replace(Location, "Piscataquis", "Piscataquis Twp")) %>%
  mutate(Location = str_replace(Location, "Prentiss Twp T7 R3 NBPP", "Prentiss Twp")) %>%
  mutate(Location = str_replace(Location, "Seboomook Lake", "Seboomook Lake Twp")) %>%
  mutate(Location = str_replace(Location, "Square Lake", "Square Lake Twp")) %>%
  mutate(Location = str_replace(Location, "Saint", "St."))

# fixing TOWN names in town_latlon_sf

town_latlon_sf <- town_latlon_sf %>% 
  mutate(TOWN = str_replace(TOWN, "Plt", "Plantation")) %>% 
  mutate(TOWN = str_replace(TOWN, "Saint", "St.")) %>% 
  mutate(TOWN = str_replace(TOWN, "Monhegan Island Plantation", "Monhegan Plantation")) %>% 
  mutate(TOWN = str_replace(TOWN, "Saint George", "St. George")) %>% 
  mutate(TOWN = str_replace(TOWN, "Matinicus Isle Plt", "Matinicus Isle Plantation")) %>% 
  mutate(TOWN = str_replace(TOWN, "Muscle Ridge Twp", "Muscle Ridge Islands Twp")) %>% 
  mutate(TOWN = str_replace(TOWN, "Andover North Surplus Twp", "Andover")) %>% 
  mutate(TOWN = str_replace(TOWN, "Andover West Surplus Twp", "Andover")) %>% 
  mutate(TOWN = str_replace(TOWN, "Magalloway Twp", "Magalloway Plantation")) %>% 
  mutate(TOWN = str_replace(TOWN, "Lincoln County Island", "Bristol")) %>% 
  mutate(TOWN = str_replace(TOWN, "Knox County Island", "Islesboro")) %>% 
  mutate(TOWN = str_replace(TOWN, "Hancock County Island", "Deer Isle")) %>% 
  mutate(TOWN = str_replace(TOWN, "T9 SD BPP", "Franklin")) %>% 
  mutate(TOWN = str_replace(TOWN, "T7 SD BPP", "Sullivan")) %>% 
  mutate(TOWN = str_replace(TOWN, "T10 SD BPP", "Franklin")) %>% 
  mutate(TOWN = str_replace(TOWN, "T16 MD BPP", "Eastbrook")) %>% 
  mutate(TOWN = str_replace(TOWN, "T22 MD BPP", "Osborn"))

# Cleaning "rates" dataframe ----------------------------------------------

# reformat rate
rates[rates == "*"] = NA
rates[rates == "NR"] = NA

rates <- rates %>% 
  mutate(lyme = as.numeric(Lyme),
       babesiosis = as.numeric(Babesiosis),
       anaplasmosis = as.numeric(Anaplasmosis)) %>% 
  select(Location, lyme, babesiosis, anaplasmosis, Population) 

# Cases per Town -----------------------------------------------
# Data from Maine Tracking Network
## Total number of lyme, anaplasmosis, and babesiosis cases per town, 2016-2020

casenum_town_latlon <- town_latlon_sf %>% 
  left_join(case_numbers, by = c("TOWN" = "Location")) %>% 
  select(-created_us, -created_da, -last_edite, -last_edi_1) %>% 
  mutate(lyme_popup = paste("<b>", TOWN, "</b>" ,
                            "<br>", "Lyme Cases: ", lyme, 
                            "<br>", "County: ", COUNTY)) %>% 
  mutate(ana_popup = paste("<b>", TOWN, "</b>" ,
                           "<br>", "Anaplasmosis Cases: ", anaplasmosis, 
                           "<br>", "County: ", COUNTY)) %>% 
  mutate(bab_popup = paste("<b>", TOWN, "</b>" ,
                           "<br>", "Babesiosis Cases: ", babesiosis, 
                           "<br>", "County: ", COUNTY)) 

# Rates by Town --------------------------------------------------
# Data from Maine Tracking Network
## Cases per 100,000 population for lyme, anaplasmosis, and babesiosis

rates_town_latlon <- town_latlon_sf %>% 
  left_join(rates, by = c("TOWN" = "Location")) %>% 
  select(-created_us, -created_da, -last_edite, -last_edi_1) %>% 
  mutate(lyme_popup = paste("<b>", TOWN, "</b>" ,
                            "<br>", "Lyme Cases per 100,000: ", lyme, 
                            "<br>", "County: ", COUNTY)) %>% 
  mutate(ana_popup = paste("<b>", TOWN, "</b>" ,
                           "<br>", "Anaplasmosis Cases per 100,000: ", anaplasmosis, 
                           "<br>", "County: ", COUNTY)) %>% 
  mutate(bab_popup = paste("<b>", TOWN, "</b>" ,
                           "<br>", "Babesiosis Cases per 100,000: ", babesiosis, 
                           "<br>", "County: ", COUNTY))

# Create color palette for each disease - cases -----------------------------------

lyme_cases_fill_palette <- colorNumeric(
  palette = "Blues",
  domain = casenum_town_latlon$lyme)

ana_cases_fill_palette <- colorNumeric(
  palette = "Reds",
  domain = casenum_town_latlon$anaplasmosis)

bab_cases_fill_palette <- colorNumeric(
  palette = "Purples",
  domain = casenum_town_latlon$babesiosis)


# Create color palette for each disease - rates ---------------------------

## log scale colors???
lyme_rates_fill_palette <- colorNumeric(
  palette = "Blues", 
  domain = rates_town_latlon$lyme)

ana_rates_fill_palette <- colorNumeric(
  palette = "Reds", 
  domain = rates_town_latlon$anaplasmosis)

bab_rates_fill_palette <- colorNumeric(
  palette = "Purples", 
  domain = rates_town_latlon$babesiosis)
```

```{r leaflet-nolayercontrol, echo=FALSE, warning=FALSE, message=FALSE, fig.cap = "Leaflet showing case numbers per town for all three diseases."}

all_layers <- leaflet() %>%
  # base map = Open Street Map
  addTiles(group = "OSM") %>%
  # add polygons for conserved lands
  addPolygons(
    data = conserved_lands_sf,
    fillColor = "green",
    color = "green",
    fillOpacity = 0.8,
    weight = 1
  ) %>%
  # add borders of counties
  addPolylines(
    data = county_latlon_sf,
    color = "black",
    fillOpacity = 0,
    weight = 1
  ) %>%
  # add towns, colored by case numbers for each disease
  addPolygons(
    data = casenum_town_latlon,
    fillColor = ~lyme_cases_fill_palette(lyme),
    color = ~lyme_cases_fill_palette(lyme),
    weight = 1,
    fillOpacity = 0.5,
    popup = ~lyme_popup
  ) %>%
  addPolygons(
    data = casenum_town_latlon,
    fillColor = ~ana_cases_fill_palette(anaplasmosis),
    color = ~ana_cases_fill_palette(anaplasmosis),
    weight = 1,
    fillOpacity = 0.5,
    popup = ~ana_popup
  ) %>%
  addPolygons(
    data = casenum_town_latlon,
    fillColor = ~bab_cases_fill_palette(babesiosis),
    color = ~bab_cases_fill_palette(babesiosis),
    weight = 1,
    fillOpacity = 0.5,
    popup = ~bab_popup
  )

all_layers
```

### Let's add some layer controls!

The `leaflet::addLayersControl` function lets you turn individual groups of polygons off and on independently. There are two sub-groupings:

1. `baseGroups` are normally alternative base maps, or polygons that you want in the background. Only one baseGroup can be turned on at a time.
2. `overlayGroups` are things that should go on top of the base map. You can have multiple overlayGroups on at a time, so it's helpful to make the polygons translucent (I used an opacity of 0.5).

Here's what the same map looks like with the conservation land data as a baseGroup, and the case numbers as overlays.

```{r leaflet-layercontrols, echo=FALSE, warning=FALSE, fig.cap = "Layers control lets us turn the polygons on and off.", include=FALSE}
# town_leaflet <- leaflet() %>%
#   # base map = Open Street Map
#   addTiles(group = "OSM") %>%
#   # add polygons for conserved lands
#   addPolygons(
#     data = conserved_lands_sf,
#     group = "Conservation Lands",
#     fillColor = "green",
#     color = "green",
#     fillOpacity = 0.8,
#     weight = 1
#   ) %>%
#   # add borders of counties
#   addPolylines(
#     data = county_latlon_sf,
#     group = "County Boundaries",
#     color = "black",
#     fillOpacity = 0,
#     weight = 1
#   ) %>%
#   # add towns, colored by case numbers for each disease
#   addPolygons(
#     data = casenum_town_latlon,
#     group = "Total Lyme Cases",
#     fillColor = ~lyme_cases_fill_palette(lyme),
#     color = ~lyme_cases_fill_palette(lyme),
#     weight = 1,
#     fillOpacity = 0.5,
#     popup = ~lyme_popup
#   ) %>%
#   addPolygons(
#     data = casenum_town_latlon,
#     group = "Total Anaplasmosis Cases",
#     fillColor = ~ana_cases_fill_palette(anaplasmosis),
#     color = ~ana_cases_fill_palette(anaplasmosis),
#     weight = 1,
#     fillOpacity = 0.5,
#     popup = ~ana_popup
#   ) %>%
#   addPolygons(
#     data = casenum_town_latlon,
#     group = "Total Babesiosis Cases",
#     fillColor = ~bab_cases_fill_palette(babesiosis),
#     color = ~bab_cases_fill_palette(babesiosis),
#     weight = 1,
#     fillOpacity = 0.5,
#     popup = ~bab_popup
#   ) %>%
#   addLayersControl(
#     baseGroups = c("Conservation Lands"),
#     overlayGroups = c("Total Lyme Cases",
#                       "Total Anaplasmosis Cases",
#                       "Total Babesiosis Cases",
#                       "Lyme Rates",
#                       "Anaplasmosis Rates",
#                       "Babesiosis Rates")
#     )
# 
# town_leaflet
```
