---
title: Ogres, Onions, Leaflet Maps...
author: Grace Acton
date: '2022-05-20'
slug: leaflet-layers
categories:
  - programming
tags:
  - maps
  - R
publishdate: '2022-05-20T12:47:41-04:00'
comments: yes
draft: true 
---

## _They have layers._

This month I've been playing around with adding layers and layer controls to Leaflet maps. 

In my Short Term course, Community-Engaged Data Science, my group and I are helping researchers at the Maine Medical Center [Vector-borne Disease Lab](https://mmcri.org/?page_id=1090) by making maps of Lyme, Anaplasmosis, and Babesiosis cases in Maine. Because these are all tickborne illnesses, we wanted to be able to overlay all of the case rates and possible predictors of higher tick rates on a single map. 

#### It got pretty crowded, pretty fast.

```{r load_sources, echo=FALSE, warning=FALSE, message=FALSE}
source("data_cleaning.R")
source("leaflet_cases_rates.R")
```

```{r leaflet-nolayercontrol, echo=FALSE, warning=FALSE, message=FALSE, fig.cap = "Leaflet showing case numbers per town for all three diseases."}

all_layers <- leaflet() %>% 
  # base map = Open Street Map
  addTiles(group = "OSM") %>% 
  # add polygons for conserved lands
  addPolygons(
    data = conserved_lands_sf,
    fillColor = "green",
    color = "green",
    fillOpacity = 0.8,
    weight = 1
  ) %>% 
  # add borders of counties
  addPolylines(
    data = county_latlon_sf,
    color = "black",
    fillOpacity = 0,
    weight = 1
  ) %>% 
  # add towns, colored by case numbers for each disease
  addPolygons(
    data = casenum_town_latlon,
    fillColor = ~lyme_cases_fill_palette(lyme),
    color = ~lyme_cases_fill_palette(lyme),
    weight = 1,
    fillOpacity = 0.5,
    popup = ~lyme_popup
  ) %>% 
  addPolygons(
    data = casenum_town_latlon,
    fillColor = ~ana_cases_fill_palette(anaplasmosis),
    color = ~ana_cases_fill_palette(anaplasmosis),
    weight = 1,
    fillOpacity = 0.5,
    popup = ~ana_popup
  ) %>%
  addPolygons(
    data = casenum_town_latlon,
    fillColor = ~bab_cases_fill_palette(babesiosis),
    color = ~bab_cases_fill_palette(babesiosis),
    weight = 1,
    fillOpacity = 0.5,
    popup = ~bab_popup
  ) 

all_layers
```

### Let's add some layer controls!

The `leaflet::addLayersControl` function lets you turn individual groups of polygons off and on independently. There are two sub-groupings:

1. `baseGroups` are normally alternative base maps, or polygons that you want in the background. Only one baseGroup can be turned on at a time.
2. `overlayGroups` are things that should go on top of the base map. You can have multiple overlayGroups on at a time, so it's helpful to make the polygons translucent (I used an opacity of 0.5).

Here's what the same map looks like with the conservation land data as a baseGroup, and the case numbers as overlays.

```{r leaflet-layercontrols, echo=FALSE, warning=FALSE, fig.cap = "Layers control lets us turn the polygons on and off."}
town_leaflet <- leaflet() %>%
  # base map = Open Street Map
  addTiles(group = "OSM") %>%
  # add polygons for conserved lands
  addPolygons(
    data = conserved_lands_sf,
    group = "Conservation Lands",
    fillColor = "green",
    color = "green",
    fillOpacity = 0.8,
    weight = 1
  ) %>%
  # add borders of counties
  addPolylines(
    data = county_latlon_sf,
    group = "County Boundaries",
    color = "black",
    fillOpacity = 0,
    weight = 1
  ) %>%
  # add towns, colored by case numbers for each disease
  addPolygons(
    data = casenum_town_latlon,
    group = "Total Lyme Cases",
    fillColor = ~lyme_cases_fill_palette(lyme),
    color = ~lyme_cases_fill_palette(lyme),
    weight = 1,
    fillOpacity = 0.5,
    popup = ~lyme_popup
  ) %>%
  addPolygons(
    data = casenum_town_latlon,
    group = "Total Anaplasmosis Cases",
    fillColor = ~ana_cases_fill_palette(anaplasmosis),
    color = ~ana_cases_fill_palette(anaplasmosis),
    weight = 1,
    fillOpacity = 0.5,
    popup = ~ana_popup
  ) %>%
  addPolygons(
    data = casenum_town_latlon,
    group = "Total Babesiosis Cases",
    fillColor = ~bab_cases_fill_palette(babesiosis),
    color = ~bab_cases_fill_palette(babesiosis),
    weight = 1,
    fillOpacity = 0.5,
    popup = ~bab_popup
  ) %>%
  addLayersControl(
    baseGroups = c("Conservation Lands"),
    overlayGroups = c("Total Lyme Cases",
                      "Total Anaplasmosis Cases",
                      "Total Babesiosis Cases",
                      "Lyme Rates",
                      "Anaplasmosis Rates",
                      "Babesiosis Rates")
    )

town_leaflet
```
